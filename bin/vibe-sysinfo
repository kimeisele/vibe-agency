#!/bin/bash
# vibe-sysinfo: System Information Fetcher
#
# Part of OPERATION FIRST_CONTACT - First real deliverable of VIBE Agency.
#
# This wrapper ensures the script runs with the correct Python interpreter
# that has psutil and rich installed.

python3 -c "
import sys
import json
import platform
import subprocess
from pathlib import Path

try:
    import psutil
    from rich.console import Console
    from rich.table import Table
    from rich.panel import Panel
except ImportError as e:
    print(f'Error: Required library not found: {e}')
    print('Install with: pip install psutil rich')
    sys.exit(1)


def get_system_info() -> dict:
    '''Gather comprehensive system information.'''
    try:
        # OS Information
        os_info = platform.platform()
        hostname = platform.node()

        # CPU Information
        cpu_count = psutil.cpu_count(logical=False)
        cpu_threads = psutil.cpu_count(logical=True)
        cpu_freq = psutil.cpu_freq()
        cpu_percent = psutil.cpu_percent(interval=0.1)

        # Memory Information
        memory = psutil.virtual_memory()
        swap = psutil.swap_memory()

        # Disk Information
        disk = psutil.disk_usage('/')

        # Uptime
        boot_time = psutil.boot_time()
        import time

        uptime_seconds = time.time() - boot_time
        uptime_days = int(uptime_seconds // 86400)
        uptime_hours = int((uptime_seconds % 86400) // 3600)
        uptime_minutes = int((uptime_seconds % 3600) // 60)

        return {
            'hostname': hostname,
            'os': os_info,
            'cpu': {
                'cores': cpu_count,
                'threads': cpu_threads,
                'frequency_mhz': cpu_freq.current if cpu_freq else 'N/A',
                'usage_percent': cpu_percent,
            },
            'memory': {
                'total_gb': round(memory.total / (1024**3), 2),
                'used_gb': round(memory.used / (1024**3), 2),
                'available_gb': round(memory.available / (1024**3), 2),
                'percent': memory.percent,
            },
            'swap': {
                'total_gb': round(swap.total / (1024**3), 2),
                'used_gb': round(swap.used / (1024**3), 2),
                'free_gb': round(swap.free / (1024**3), 2),
                'percent': swap.percent,
            },
            'disk': {
                'total_gb': round(disk.total / (1024**3), 2),
                'used_gb': round(disk.used / (1024**3), 2),
                'free_gb': round(disk.free / (1024**3), 2),
                'percent': disk.percent,
            },
            'uptime': {
                'days': uptime_days,
                'hours': uptime_hours,
                'minutes': uptime_minutes,
                'total_seconds': int(uptime_seconds),
            },
        }
    except Exception as e:
        print(f'Error gathering system info: {e}', file=sys.stderr)
        sys.exit(1)


def display_table(info: dict) -> None:
    '''Display system information in a beautiful table format.'''
    console = Console()

    # Main panel
    title = f'ðŸ–¥ï¸  SYSTEM INFO: {info[\"hostname\"]}'
    console.print(Panel(title, style='bold blue'))

    # OS Information
    os_table = Table(title='ðŸ“‹ System', show_header=False, box=None)
    os_table.add_row('OS', info['os'])
    console.print(os_table)

    # CPU Table
    cpu_table = Table(title='âš™ï¸  CPU', show_header=True)
    cpu_table.add_column('Property', style='cyan')
    cpu_table.add_column('Value', style='green')
    cpu_table.add_row('Physical Cores', str(info['cpu']['cores']))
    cpu_table.add_row('Logical Threads', str(info['cpu']['threads']))
    cpu_table.add_row('Frequency (MHz)', str(info['cpu']['frequency_mhz']))
    cpu_table.add_row('Usage', f\"{info['cpu']['usage_percent']}%\")
    console.print(cpu_table)

    # Memory Table
    mem_table = Table(title='ðŸ’¾ Memory', show_header=True)
    mem_table.add_column('Property', style='cyan')
    mem_table.add_column('Value', style='green')
    mem_table.add_row('Total', f\"{info['memory']['total_gb']} GB\")
    mem_table.add_row('Used', f\"{info['memory']['used_gb']} GB\")
    mem_table.add_row('Available', f\"{info['memory']['available_gb']} GB\")
    mem_table.add_row('Usage', f\"{info['memory']['percent']}%\")
    console.print(mem_table)

    # Disk Table
    disk_table = Table(title='ðŸ’¿ Disk', show_header=True)
    disk_table.add_column('Property', style='cyan')
    disk_table.add_column('Value', style='green')
    disk_table.add_row('Total', f\"{info['disk']['total_gb']} GB\")
    disk_table.add_row('Used', f\"{info['disk']['used_gb']} GB\")
    disk_table.add_row('Free', f\"{info['disk']['free_gb']} GB\")
    disk_table.add_row('Usage', f\"{info['disk']['percent']}%\")
    console.print(disk_table)

    # Uptime Table
    uptime_table = Table(title='â±ï¸  Uptime', show_header=False, box=None)
    uptime_str = f\"{info['uptime']['days']}d {info['uptime']['hours']}h {info['uptime']['minutes']}m\"
    uptime_table.add_row('System Running', uptime_str)
    console.print(uptime_table)


def display_json(info: dict) -> None:
    '''Display system information as JSON.'''
    print(json.dumps(info, indent=2))


def main():
    '''Main entry point.'''
    import argparse

    parser = argparse.ArgumentParser(
        description='Display beautiful system information',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
Examples:
  bin/vibe-sysinfo           # Show formatted table
  bin/vibe-sysinfo --json    # Show JSON output
        ''',
    )

    parser.add_argument(
        '--json',
        action='store_true',
        help='Output as JSON instead of formatted table',
    )
    parser.add_argument(
        '--version',
        action='version',
        version='vibe-sysinfo 1.0.0',
    )

    args = parser.parse_args()

    # Gather info
    info = get_system_info()

    # Display
    if args.json:
        display_json(info)
    else:
        display_table(info)


if __name__ == '__main__':
    main()
" "$@"
